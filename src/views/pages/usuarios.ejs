<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Tell the browser to be responsive to screen width -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Favicon icon -->
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon.png">
    <title>Tuvansa</title>
    <!-- Bootstrap Core CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <!-- Custom CSS -->
    <link href="css/style.css" rel="stylesheet">
    <!-- You can change the theme colors from here -->
    <link href="css/colors/default-dark.css" id="theme" rel="stylesheet">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

    <style>
        .iframe-container {
            padding-bottom: 60%;
            padding-top: 30px;
            height: 0;
            overflow: hidden;
        }

        .iframe-container iframe,
        .iframe-container object,
        .iframe-container embed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .modal.in .modal-dialog {
            transform: none;
            /*translate(0px, 0px);*/
        }

        .form-control {
            width: 50%;
            min-height: 0px;
        }

        td.details-control {
            background: url('images/details_open.png') no-repeat center center;

            cursor: pointer;
        }

        tr.details td.details-control {
            background: url('images/details_close.png') no-repeat center center;
        }

        button.close {
            padding: 0;
            background: 0 0;
            border: 0;
            -webkit-appearance: none;
        }

        .close {
            float: right;
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1;
            color: #000;
            text-shadow: 0 1px 0 #fff;
            opacity: .5;

        }
    </style>

</head>

<%- include ('../partials/preloader.ejs'); -%>
    <!-- ============================================================== -->
    <!-- Main wrapper - style you can find in pages.scss -->
    <!-- ============================================================== -->
    <!--  <div id="main-wrapper"> -->
    <%- include ('../partials/header.ejs'); -%>
        <!-- ============================================================== -->
        <!-- End Topbar header -->
        <!-- ============================================================== -->
        <!-- ============================================================== -->
        <!-- Left Sidebar - style you can find in sidebar.scss  -->
        <!-- ============================================================== -->
        <%- include ('../partials/left-sidebar.ejs') -%>
            <!-- ============================================================== -->
            <!-- End Left Sidebar - style you can find in sidebar.scss  -->
            <!-- ============================================================== -->
            <!-- ============================================================== -->
            <!-- Page wrapper  -->
            <!-- ============================================================== -->
            <div class="page-wrapper">
                <!-- ============================================================== -->
                <!-- Container fluid  -->
                <!-- ============================================================== -->
                <div class="container-fluid ">
                    <!-- r-aside -->
                    <!-- ============================================================== -->
                    <!-- Bread crumb and right sidebar toggle -->
                    <!-- ============================================================== -->
                    <%- include ('../partials/breadcrumb.ejs') -%>
                        <!-- ============================================================== -->
                        <!-- End Bread crumb and right sidebar toggle -->
                        <!-- ============================================================== -->
                        <!-- ============================================================== -->
                        <!-- Sales overview chart -->
                        <!-- ============================================================== -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table id="usuarios" class="table table-sm table-hover"
                                                style="width:100%; font-size:11px; ">
                                                <thead>
                                                    <tr>
                                                        <th>id</th>
                                                        <th>Nombre</th>
                                                        <th>Apellido</th>
                                                        <th>Usuario</th>
                                                        <th>Password</th>
                                                        <th>SubirCierre</th>
                                                        <th>Fecha Alta</th>
                                                        <th>Area</th>
                                                        <th>Sucursal</th>
                                                        <th>Rol</th>

                                                    </tr>
                                                </thead>

                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="fade modal " id="nuevoUsuario" tabindex="" role="dialog"
                            aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered modal-xs modal-dialog-scrollable"
                                role="document">
                                <div class="modal-content">
                                    <div class="modal-header bg-success text-center">
                                        <h5 class="modal-title "> <strong>Nuevo Usuario</strong></h5>
                                        <button type="button" id="boton" class="close" data-dismiss="modal"
                                            aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="userForm" name="userForm" enctype="multipart/form-data"
                                            class="form-horizontal form-bordered">
                                            <div class="form-body">
                                                <div class="form-group row">
                                                    <label class="control-label text-right col-md-3">Nombre</label>
                                                    <div class="col-md-9">
                                                        <input type="text" id="nombre" name="nombre" required
                                                            class="form-control">

                                                    </div>

                                                </div>
                                                <div class="form-group row">
                                                    <label class="control-label text-right col-md-3">Apellido</label>
                                                    <div class="col-md-9">
                                                        <input type="text" id="apellido" name="apellido" required
                                                            class="form-control">

                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label class="control-label text-right col-md-3">Usuario</label>
                                                    <div class="col-md-9">
                                                        <input type="text" id="user" name="user" required
                                                            class="form-control">

                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label class="control-label text-right col-md-3">Password</label>
                                                    <div class="col-md-9">
                                                        <input type="password" id="password" name="password" required
                                                            class="form-control">

                                                    </div>
                                                </div>

                                                <div class="form-group row">
                                                    <label class="control-label text-right col-md-3">Upload</label>
                                                    <div class="col-md-9">
                                                        <select id="upload" class="form-control custom-select" required
                                                            name="upload">
                                                            <option value="1">si</option>
                                                            <option value="0">no</option>
                                                        </select>
                                                    </div>
                                                </div>

                                                <div class="form-group row">
                                                    <label class="control-label text-right col-md-3">Area</label>
                                                    <div class="col-md-9">
                                                        <select class="form-control custom-select" id="idArea" required
                                                            name="idArea">
                                                            <option value="1">Sistemas</option>
                                                            <option value="2">Ventas</option>
                                                            <option value="3">Otro</option>
                                                            <option value="4">Compras</option>
                                                            <option value="5">Almacen</option>
                                                            <option value="6">Contabilidad</option>
                                                            <option value="7">RH</option>
                                                            <option value="8">CxC</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label class="control-label text-right col-md-3">Rol</label>
                                                    <div class="col-md-9">
                                                        <select class="form-control custom-select" id="idRol" required
                                                            name="idRol">
                                                            <option value="1">Administrador</option>
                                                            <option value="2">Almacenista</option>
                                                            <option value="3">Vendedor</option>
                                                            <option value="4">Upload</option>
                                                            <option value="5">Certificado</option>

                                                        </select>
                                                    </div>
                                                </div>

                                                <div class="form-group row">
                                                    <label class="control-label text-right col-md-3">Sucursal</label>
                                                    <div class="col-md-9">
                                                        <select class="form-control custom-select" id="idSucursal"
                                                            required name="idSucursal">

                                                            <option value="1">Mexico</option>
                                                            <option value="2">Monterrey</option>
                                                            <option value="3">Mexicali</option>
                                                            <option value="4">Veracruz</option>
                                                            <option value="5">Cancun</option>
                                                            <option value="6">Queretaro</option>

                                                        </select>
                                                    </div>
                                                </div>

                                                <div class="form-actions">
                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <div class="row">
                                                                <div class="offset-sm-3 col-md-9">
                                                                    <button id="btnSubmit" type="submit" 
                                                                        class="btn btn-success"> <i
                                                                            class="fa fa-check"></i> Submit</button>
                                                                    <button type="button"
                                                                        class="btn btn-inverse">Cancel</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ============================================================== -->
                        <!-- End Container fluid  -->
                        <!-- ============================================================== -->
                        <%- include ('../partials/footer.ejs') -%>


                            <script>

                                $(document).ready(function () {


                                    let usuarios = $('#usuarios').DataTable({
                                        "bDestroy": true,

                                        "processing": true,
                                        "serverSide": true,
                                        "ajax": {
                                            url: `/usuariosTable`,
                                            type: "GET"
                                        },
                                        "columns": [
                                            { "data": [0] },
                                            { "data": [1] },
                                            { "data": [2] },
                                            { "data": [3] },
                                            {
                                                "data": [4],
                                                "defaultContent": "*************"
                                            },
                                            {
                                                "data": [5],
                                                render: (data, type, row) => data ? 'si' : 'no'
                                            },
                                            { "data": [6] },
                                            { "data": [7] },
                                            { "data": [8] },
                                            { "data": [9] },
                                        ],
                                        "dom": 'Bfrtip',
                                        "buttons": [{
                                            text: 'Alta',
                                            action: function (e, dt, node, config) {

                                            },
                                            attr: {
                                                "data-target": '#nuevoUsuario',
                                                "data-toggle": "modal"
                                            }
                                        }
                                        ],

                                    })

                                    usuarios.on('draw.dt', function () {

                                        $(this).Tabledit({
                                            url: `/usuarios`,
                                            eventType: 'dblclick',
                                            deleteButton: true,
                                            editButton: true,

                                            //dataType: 'json',
                                            columns: {
                                                identifier: [0, 'id'],
                                                editable: [
                                                    [1, 'nombre'],
                                                    [2, 'apellido'],
                                                    [3, 'user'],
                                                    [4, 'password'],
                                                    [5, 'upload', `{
                                                            "0":"no",
                                                            "1":"si"
                                                        }`],
                                                    [7, "idArea", `{
                                                            "1":"Sistemas",
                                                            "2":"Ventas",
                                                            "3":"Otro",
                                                            "4":"Compras",
                                                            "5":"Almacen",
                                                            "6":"Contabilidad",
                                                            "7":"Recursos Humanos",
                                                            "8":"Credito y Cobranza"
                                                        }`],
                                                    [8, 'idSucursal', '{"1":"Mexico","2":"Monterrey","3":"Mexicali","4":"Veracruz","5":"Cancun","6":"Queretaro"} '],
                                                    [9, 'idRol', '{"1":"administrador","2":"Almacenista","3":"Vendedor","4":"Upload","5":"Certificado"}']
                                                ]
                                            },
                                            onSuccess: function (data, textStatus, jqXHR) {

                                                usuarios.draw() 

                                                Swal.fire({
                                                    position: 'top-end',
                                                    icon: 'success',
                                                    title: `${data.message}`,
                                                    showConfirmButton: true
                                                })
                                            }, onFail: function (jqXHR, textStatus, errorThrown) {

                                                Swal.fire({
                                                    icon: 'error',
                                                    title: 'Error',
                                                    text: `${jqXHR.responseJSON.message}`,
                                                })

                                            },


                                        })

                                    })


                                    $('#userForm').on('submit', function (e) {
                                        e.preventDefault();

                                        let form = {
                                            nombre: document.querySelector('#nombre').value,
                                            apellido: document.querySelector('#apellido').value,
                                            user: document.querySelector('#user').value,
                                            password: document.querySelector('#password').value,
                                            upload: parseInt(document.querySelector('#upload').value),
                                            idArea: parseInt(document.querySelector('#idArea').value),
                                            idRol: parseInt(document.querySelector('#idRol').value),
                                            idSucursal: parseInt(document.querySelector('#idSucursal').value)
                                        }


                                        $.ajax({
                                            url: '/usuarioNuevo',
                                            type: 'POST',
                                            data: form,

                                            success: function (resp) {

                                                console.log(resp);

                                                $('#nuevoUsuario').modal('hide');

                                                usuarios.draw();

                                                Swal.fire({
                                                    position: 'top-end',
                                                    icon: 'success',
                                                    title: `${resp.message}`,
                                                    showConfirmButton: true
                                                })
                                            },
                                            error: function (err) {

                                                console.log(err)
                                                
                                                Swal.fire({
                                                    icon: 'error',
                                                    title: 'Error',
                                                    text: `${err.responseJSON.message}`,
                                                })
                                            }

                                        })


                                    })

                                })


                            </script>